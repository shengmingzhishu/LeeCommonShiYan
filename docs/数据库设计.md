# 灵力检测实验室数据库设计

## 1. 数据库ER图

```
                    ┌─────────────────┐
                    │     cities      │◄───────────────┐
                    │   城市表        │                │
                    ├─────────────────┤                │
                    │ id              │                │
                    │ name            │                │
                    │ code            │                │
                    │ province        │                │
                    │ status          │                │
                    └─────────────────┘                │
                             │                         │
                             │                         │
                    ┌─────────────────┐                │
                    │   companies     │                │
                    │    公司表        │                │
                    ├─────────────────┤                │
                    │ id              │                │
                    │ city_id (FK)    │◄───────────────┼─────────┐
                    │ name            │                │         │
                    │ code            │                │         │
                    │ address         │                │         │
                    │ contact_phone   │                │         │
                    │ contact_email   │                │         │
                    │ status          │                │         │
                    │ created_at      │                │         │
                    └─────────────────┘                │         │
                             │                         │         │
                             │                         │         │
        ┌────────────────────┼─────────────────────────┼─────────┼─────────────┐
        │                    │                         │         │             │
        ▼                    ▼                         ▼         ▼             ▼
┌───────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────┐   ┌─────────────┐
│     users     │   │ package_    │   │   orders    │   │ logistics│   │ test_       │
│    用户表      │   │ categories  │   │    订单表    │   │  物流表  │   │  reports    │
├───────────────┤   ├─────────────┤   ├─────────────┤   ├─────────┤   ├─────────────┤
│ id            │   │ id          │   │ id          │   │ id      │   │ id          │
│ username      │   │ name        │   │ user_id     │   │ order_id│   │ order_id    │
│ password      │   │ code        │   │ company_id  │   │ type    │   │ sampler_id  │
│ phone         │   │ parent_id   │   │ total_amount│   │ status  │   │ file_url    │
│ email         │   │ sort_order  │   │ status      │   │ tracking│   │ file_type   │
│ status        │   │ status      │   │ pay_status  │   │ created_│   │ upload_time │
│ created_at    │   │ created_at  │   │ created_at  │   │ at      │   │ created_at  │
└───────┬───────┘   └─────────────┘   └───────┬─────┘   └─────────┘   └───────┬─────┘
        │                                   │                                   │
        │                                   │                                   │
        │                                   │                                   │
        │                        ┌──────────▼─────────┐                         │
        │                        │   order_items      │                         │
        │                        │    订单详情表        │                         │
        │                        ├─────────────────────┤                         │
        │                        │ id                  │                         │
        │                        │ order_id (FK)       │                         │
        │                        │ package_id (FK)     │                         │
        │                        │ quantity            │                         │
        │                        │ unit_price          │                         │
        │                        │ total_price         │                         │
        │                        └─────────────────────┘                         │
        │                                                                          │
        │                                                                          │
        ▼                                                                          ▼
┌─────────────────┐                                                       ┌─────────────────┐
│  user_profiles  │                                                       │ user_companies  │
│   用户资料表     │                                                       │  用户公司关联表   │
├─────────────────┤                                                       ├─────────────────┤
│ id              │                                                       │ id              │
│ user_id (FK)    │                                                       │ user_id (FK)    │
│ real_name       │                                                       │ company_id (FK) │
│ id_card         │                                                       │ role            │
│ gender          │                                                       │ created_at      │
│ birth_date      │                                                       └─────────────────┘
│ address         │                                                                ▲
│ emergency_contact│                                                               │
│ emergency_phone │                                                               │
│ created_at      │                                                               │
└─────────────────┘                                                               │
                                                                                  │
                                                                                  │
        ┌──────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────┐
│    samplers     │
│   采样人信息表    │
├─────────────────┤
│ id              │
│ user_id (FK)    │
│ name            │
│ gender          │
│ age             │
│ phone           │
│ id_card         │
│ address         │
│ medical_history │
│ created_at      │
└─────────────────┘
```

## 2. 详细表结构设计

### 2.1 城市表 (cities)

```sql
CREATE TABLE cities (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    name VARCHAR(50) NOT NULL COMMENT '城市名称',
    code VARCHAR(20) UNIQUE NOT NULL COMMENT '城市代码',
    province VARCHAR(50) NOT NULL COMMENT '所属省份',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_code (code),
    INDEX idx_status (status)
) COMMENT '城市表';
```

### 2.2 公司表 (companies)

```sql
CREATE TABLE companies (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    city_id BIGINT NOT NULL COMMENT '所属城市ID',
    name VARCHAR(100) NOT NULL COMMENT '公司名称',
    code VARCHAR(20) UNIQUE NOT NULL COMMENT '公司代码',
    address TEXT COMMENT '公司地址',
    contact_phone VARCHAR(20) COMMENT '联系电话',
    contact_email VARCHAR(100) COMMENT '联系邮箱',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (city_id) REFERENCES cities(id),
    INDEX idx_city_id (city_id),
    INDEX idx_code (code),
    INDEX idx_status (status)
) COMMENT '公司表';
```

### 2.3 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(255) NOT NULL COMMENT '密码(BCrypt加密)',
    phone VARCHAR(20) UNIQUE COMMENT '手机号',
    email VARCHAR(100) UNIQUE COMMENT '邮箱',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    last_login_at TIMESTAMP NULL COMMENT '最后登录时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_phone (phone),
    INDEX idx_email (email),
    INDEX idx_status (status)
) COMMENT '用户表';
```

### 2.4 用户资料表 (user_profiles)

```sql
CREATE TABLE user_profiles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    real_name VARCHAR(50) COMMENT '真实姓名',
    id_card VARCHAR(20) COMMENT '身份证号',
    gender TINYINT COMMENT '性别：0-未知，1-男，2-女',
    birth_date DATE COMMENT '出生日期',
    address TEXT COMMENT '联系地址',
    emergency_contact VARCHAR(50) COMMENT '紧急联系人',
    emergency_phone VARCHAR(20) COMMENT '紧急联系电话',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_id_card (id_card)
) COMMENT '用户资料表';
```

### 2.5 采样人信息表 (samplers)

```sql
CREATE TABLE samplers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    name VARCHAR(50) NOT NULL COMMENT '采样人姓名',
    gender TINYINT COMMENT '性别：0-未知，1-男，2-女',
    age INT COMMENT '年龄',
    phone VARCHAR(20) COMMENT '联系电话',
    id_card VARCHAR(20) COMMENT '身份证号',
    address TEXT COMMENT '详细地址',
    medical_history TEXT COMMENT '病史信息',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_name (name),
    INDEX idx_phone (phone)
) COMMENT '采样人信息表';
```

### 2.6 套餐分类表 (package_categories)

```sql
CREATE TABLE package_categories (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    name VARCHAR(100) NOT NULL COMMENT '分类名称',
    code VARCHAR(20) UNIQUE NOT NULL COMMENT '分类代码',
    parent_id BIGINT DEFAULT 0 COMMENT '父分类ID，0表示顶级分类',
    sort_order INT DEFAULT 0 COMMENT '排序顺序',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (parent_id) REFERENCES package_categories(id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_code (code),
    INDEX idx_status (status)
) COMMENT '套餐分类表';
```

### 2.7 体检套餐表 (health_packages)

```sql
CREATE TABLE health_packages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    category_id BIGINT NOT NULL COMMENT '分类ID',
    name VARCHAR(100) NOT NULL COMMENT '套餐名称',
    code VARCHAR(20) UNIQUE NOT NULL COMMENT '套餐代码',
    description TEXT COMMENT '套餐描述',
    price DECIMAL(10,2) NOT NULL COMMENT '套餐价格',
    original_price DECIMAL(10,2) COMMENT '原价',
    cover_image VARCHAR(255) COMMENT '封面图片',
    detail_images JSON COMMENT '详情图片列表',
    test_items JSON COMMENT '检测项目列表',
    sampling_method TINYINT NOT NULL COMMENT '采样方式：1-自采样，2-上门采样，3-两种方式',
    report_delivery_days INT DEFAULT 7 COMMENT '报告交付天数',
    stock INT DEFAULT 9999 COMMENT '库存数量',
    sort_order INT DEFAULT 0 COMMENT '排序顺序',
    status TINYINT DEFAULT 1 COMMENT '状态：0-下架，1-上架',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (category_id) REFERENCES package_categories(id),
    INDEX idx_category_id (category_id),
    INDEX idx_code (code),
    INDEX idx_status (status),
    FULLTEXT idx_search (name, description)
) COMMENT '体检套餐表';
```

### 2.8 用户公司关联表 (user_companies)

```sql
CREATE TABLE user_companies (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    company_id BIGINT NOT NULL COMMENT '公司ID',
    role TINYINT DEFAULT 1 COMMENT '用户角色：1-普通用户，2-公司管理员，3-城市管理员',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_company (user_id, company_id),
    INDEX idx_user_id (user_id),
    INDEX idx_company_id (company_id),
    INDEX idx_role (role)
) COMMENT '用户公司关联表';
```

### 2.9 购物车表 (shopping_cart)

```sql
CREATE TABLE shopping_cart (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    package_id BIGINT NOT NULL COMMENT '套餐ID',
    quantity INT DEFAULT 1 COMMENT '数量',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (package_id) REFERENCES health_packages(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_package (user_id, package_id),
    INDEX idx_user_id (user_id),
    INDEX idx_package_id (package_id)
) COMMENT '购物车表';
```

### 2.10 订单表 (orders)

```sql
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_no VARCHAR(32) UNIQUE NOT NULL COMMENT '订单号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    company_id BIGINT NOT NULL COMMENT '所属公司ID',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
    paid_amount DECIMAL(10,2) DEFAULT 0 COMMENT '已支付金额',
    status TINYINT DEFAULT 1 COMMENT '订单状态：1-待支付，2-已支付，3-待发货，4-已发货，5-已完成，6-已取消',
    pay_status TINYINT DEFAULT 1 COMMENT '支付状态：1-待支付，2-支付中，3-已支付，4-支付失败',
    pay_type VARCHAR(20) COMMENT '支付方式',
    pay_time TIMESTAMP NULL COMMENT '支付时间',
    shipping_type TINYINT COMMENT '配送方式：1-自邮寄，2-上门取样',
    shipping_address TEXT COMMENT '配送地址',
    contact_name VARCHAR(50) COMMENT '联系人姓名',
    contact_phone VARCHAR(20) COMMENT '联系电话',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (company_id) REFERENCES companies(id),
    INDEX idx_user_id (user_id),
    INDEX idx_company_id (company_id),
    INDEX idx_order_no (order_no),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) COMMENT '订单表';
```

### 2.11 订单详情表 (order_items)

```sql
CREATE TABLE order_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    package_id BIGINT NOT NULL COMMENT '套餐ID',
    package_name VARCHAR(100) NOT NULL COMMENT '套餐名称(快照)',
    package_price DECIMAL(10,2) NOT NULL COMMENT '套餐单价(快照)',
    quantity INT NOT NULL COMMENT '数量',
    total_price DECIMAL(10,2) NOT NULL COMMENT '小计',
    sampler_name VARCHAR(50) COMMENT '采样人姓名',
    sampler_id_card VARCHAR(20) COMMENT '采样人身份证',
    sampler_phone VARCHAR(20) COMMENT '采样人电话',
    sampler_address TEXT COMMENT '采样人地址',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (package_id) REFERENCES health_packages(id),
    INDEX idx_order_id (order_id),
    INDEX idx_package_id (package_id)
) COMMENT '订单详情表';
```

### 2.12 物流表 (logistics)

```sql
CREATE TABLE logistics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    type TINYINT NOT NULL COMMENT '物流类型：1-设备配送，2-样品回收',
    company_name VARCHAR(100) COMMENT '物流公司名称',
    tracking_no VARCHAR(50) COMMENT '快递单号',
    status TINYINT DEFAULT 1 COMMENT '物流状态：1-待发货，2-已发货，3-运输中，4-已签收，5-异常',
    sender_name VARCHAR(50) COMMENT '发货人姓名',
    sender_phone VARCHAR(20) COMMENT '发货人电话',
    sender_address TEXT COMMENT '发货地址',
    receiver_name VARCHAR(50) COMMENT '收货人姓名',
    receiver_phone VARCHAR(20) COMMENT '收货人电话',
    receiver_address TEXT COMMENT '收货地址',
    shipped_at TIMESTAMP NULL COMMENT '发货时间',
    delivered_at TIMESTAMP NULL COMMENT '签收时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (order_id) REFERENCES orders(id),
    INDEX idx_order_id (order_id),
    INDEX idx_type (type),
    INDEX idx_status (status)
) COMMENT '物流表';
```

### 2.13 检验报告表 (test_reports)

```sql
CREATE TABLE test_reports (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键ID',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    order_item_id BIGINT NOT NULL COMMENT '订单项ID',
    sampler_id BIGINT NOT NULL COMMENT '采样人ID',
    file_name VARCHAR(255) NOT NULL COMMENT '文件名',
    file_url VARCHAR(500) NOT NULL COMMENT '文件访问URL',
    file_type VARCHAR(10) NOT NULL COMMENT '文件类型：pdf,doc,docx',
    file_size BIGINT COMMENT '文件大小(字节)',
    report_type TINYINT DEFAULT 1 COMMENT '报告类型：1-检验报告，2-健康建议',
    upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
    uploaded_by BIGINT COMMENT '上传人ID',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，2-已删除',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (order_item_id) REFERENCES order_items(id),
    FOREIGN KEY (sampler_id) REFERENCES samplers(id),
    INDEX idx_order_id (order_id),
    INDEX idx_order_item_id (order_item_id),
    INDEX idx_sampler_id (sampler_id),
    INDEX idx_status (status)
) COMMENT '检验报告表';
```

## 3. 数据库索引设计

### 3.1 主要业务索引
- 用户表：phone、email、status
- 订单表：user_id、company_id、order_no、created_at
- 套餐表：category_id、status、名称模糊搜索

### 3.2 复合索引
- 用户公司关联表：user_id + company_id
- 购物车：user_id + package_id
- 订单状态查询：status + created_at

## 4. 数据字典

### 4.1 通用状态码
```sql
-- 用户状态
0: 禁用
1: 启用

-- 订单状态  
1: 待支付
2: 已支付
3: 待发货
4: 已发货
5: 已完成
6: 已取消

-- 支付状态
1: 待支付
2: 支付中
3: 已支付
4: 支付失败

-- 性别
0: 未知
1: 男
2: 女

-- 采样方式
1: 自采样
2: 上门采样
3: 两种方式
```

## 5. 数据库约束

### 5.1 外键约束
- 所有业务表都有适当的ON DELETE CASCADE或RESTRICT约束
- 用户删除时，关联数据采用逻辑删除或级联删除

### 5.2 唯一约束
- 用户名、手机号、邮箱唯一
- 套餐代码、公司代码、城市代码唯一
- 购物车用户-套餐组合唯一

## 6. 数据初始化

### 6.1 超级管理员数据
```sql
-- 超级管理员用户
INSERT INTO users (username, password, phone, email, status) VALUES 
('root', '$2a$10$...', '13800000000', 'admin@company.com', 1);

-- 超级管理员公司
INSERT INTO cities (name, code, province, status) VALUES 
('系统城市', 'SYSTEM', '系统', 1);

INSERT INTO companies (city_id, name, code, address, contact_phone, contact_email, status) VALUES 
(1, '灵力检测总部', 'LEADING_CORP', '系统默认地址', '400-000-0000', 'admin@company.com', 1);
```

### 6.2 基础数据
- 默认套餐分类
- 系统默认城市
- 常用检测项目字典